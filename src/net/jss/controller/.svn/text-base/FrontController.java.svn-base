package net.saje.controller;

import java.io.IOException;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

//import org.apache.catalina.comet.CometEvent;

import net.saje.controller.processors.AjaxProcessor;
import net.saje.controller.processors.ConsoleProcessor;
import net.saje.controller.processors.PageRequestProcessor;
import net.saje.controller.processors.SajeProcessor;
import net.saje.controller.processors.CometProcessor;

public class FrontController extends HttpServlet{// implements org.apache.catalina.comet.CometProcessor  {

	private static final long serialVersionUID = -3364415826397739136L;

	public static SajeContext context;

	private boolean isGet;
	
	private AjaxProcessor ajaxProcessor;
	private ConsoleProcessor consoleProcessor;
	private PageRequestProcessor pageRequestProcessor;
	private CometProcessor cometProcessor;
	
	
	
	@Override
	public void init() throws ServletException {
		super.init();
		this.ajaxProcessor = new AjaxProcessor();
		this.consoleProcessor = new ConsoleProcessor();
		this.pageRequestProcessor = new PageRequestProcessor();
		this.cometProcessor = new CometProcessor();
	}

	@Override
	public void doGet(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {
		this.isGet = true;
		System.out.println("GET");
		this.serviceRequest(request, response);
	}

	@Override
	public void doPost(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {
		this.isGet = false;
		System.out.println("POST");
		this.serviceRequest(request, response);
	}

	private void serviceRequest(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {

		FrontController.context = new SajeContext(request, response);

		System.out.println("Front controller: received "
				+ (isGet ? "GET" : "POST") + " request for "
				+ request.getServletPath());

		if (request.getServletPath().equals("/ajax/")) {
			this.process(this.ajaxProcessor);
		} else if (request.getServletPath().equals("/console/")) {
			this.process(this.consoleProcessor);
		} else if (request.getServletPath().equals("/comet/")) {
			this.process(this.cometProcessor);
		} else {
			this.process(this.pageRequestProcessor);
		}

	}

	private void process(SajeProcessor processor) throws ServletException,
			IOException {
		HttpServletRequest request = FrontController.context.getRequest();
		HttpServletResponse response = FrontController.context.getResponse();
		ServletContext servletContext = FrontController.context
				.getServletContext();
		System.out.println("Request is handled by "+processor.getClass());
		if (isGet) {
			processor.doGet(request, response, servletContext);
		} else {
			processor.doPost(request, response, servletContext);
		}
	}

	@Override
	public void event(CometEvent event) throws IOException, ServletException {
		System.out.println("Received comet event: "+event.getEventType().toString());
		FrontController.context = new SajeContext(event.getHttpServletRequest(), 
				event.getHttpServletResponse());
		this.cometProcessor.setEvent(event);
		this.serviceRequest(event.getHttpServletRequest(), event.getHttpServletResponse());
	}
}
